<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ data.name }} - Portfolio</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="container">
        <aside class="sidebar">
            <div class="profile">
                <h1>{{ data.name }}</h1>
                <p class="role">{{ data.summary[:50] }}...</p> <!-- Fallback concise role if not explicitly in JSON -->
            </div>
            <nav>
                <ul>
                    <li><a href="#about">About</a></li>
                    <li><a href="#experience">Experience</a></li>
                    <li><a href="#projects">Projects</a></li>
                    <li><a href="#skills">Skills</a></li>
                    <li><a href="#contact">Contact</a></li>
                </ul>
            </nav>
            <div class="contact-mini">
                {% if data.contact.email %}
                <p><a href="mailto:{{ data.contact.email }}">Email Me</a></p>
                {% endif %}
            </div>
        </aside>
        <main class="content">
            {% block content %}{% endblock %}
        </main>
    </div>
    <div class="chat-widget">
        <button id="chat-toggle" class="chat-button">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
        </button>
        <div id="chat-window" class="chat-window hidden">
            <div class="chat-header">
                <h3>Chat with My Resume</h3>
                <button id="chat-close" class="close-button">&times;</button>
            </div>
            <div id="chat-messages" class="chat-messages">
                <div class="message bot">
                    <p>Hi! Ask me anything about Debasriya's resume.</p>
                </div>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chat-input" placeholder="Type a message...">
                <button id="chat-send">Send</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const chatToggle = document.getElementById('chat-toggle');
            const chatWindow = document.getElementById('chat-window');
            const chatClose = document.getElementById('chat-close');
            const chatInput = document.getElementById('chat-input');
            const chatSend = document.getElementById('chat-send');
            const chatMessages = document.getElementById('chat-messages');

            function toggleChat() {
                chatWindow.classList.toggle('hidden');
            }

            function addMessage(text, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', sender);
                const p = document.createElement('p');
                p.textContent = text;
                messageDiv.appendChild(p);
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            async function sendMessage() {
                const text = chatInput.value.trim();
                if (!text) return;

                addMessage(text, 'user');
                chatInput.value = '';

                // Show loading indicator
                const loadingDiv = document.createElement('div');
                loadingDiv.classList.add('message', 'bot', 'loading');
                loadingDiv.textContent = '...';
                chatMessages.appendChild(loadingDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                try {
                    const response = await fetch('/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ message: text })
                    });

                    const data = await response.json();

                    // Remove loading indicator
                    chatMessages.removeChild(loadingDiv);

                    if (data.error) {
                        addMessage('Error: ' + data.error, 'bot');
                    } else {
                        addMessage(data.response, 'bot');
                    }
                } catch (error) {
                    chatMessages.removeChild(loadingDiv);
                    addMessage('Error connecting to server.', 'bot');
                }
            }

            chatToggle.addEventListener('click', toggleChat);
            chatClose.addEventListener('click', toggleChat);
            chatSend.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
        });
    </script>
</body>

</html>